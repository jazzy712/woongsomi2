{# templates/accounts/profile.html #}
{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  .profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    background-color: #f0f0f0;
    flex-shrink: 0;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .profile-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .section-card {
    background: #f0f8ff;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  }
</style>

<div class="container py-5">

  <!-- 헤더: 아바타 + 유저명 + 팔로우 정보 + 수정 버튼 -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">

    <div class="d-flex align-items-center">
      <!-- 클릭 가능한 원형 아바타 -->
      <div id="avatar-click" class="profile-avatar me-4">
        <img
          src="{% if person.profile_image %}{{ person.profile_image.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}"
          alt="프로필 사진"
        >
      </div>
      <div>
        <h1 class="h3 mb-1">{{ person.username }}님의 프로필</h1>
        </h1>
        <small class="text-muted">
          팔로잉: <strong>{{ person.followings.count }}</strong> /
          팔로워: <strong>{{ person.followers.count }}</strong>
        </small>
      </div>
    </div>

    {% if request.user == person %}
      <a href="{% url 'accounts:update' person.pk %}" class="btn btn-outline-secondary">
        프로필 수정
      </a>
    {% endif %}

  </div>

  <!-- 숨겨진 아바타 업로드 폼 -->
  <form
    id="avatar-form"
    action="{% url 'accounts:avatar_upload' person.pk %}"
    method="POST"
    enctype="multipart/form-data"
    style="display: none;"
  >
    {% csrf_token %}
    <input
      type="file"
      name="profile_image"
      id="avatar-input"
      accept="image/*"
    >
  </form>

  <!-- 가입한 금융 상품 -->
  <div class="section-card">
    <h2 class="h5">💼 가입한 금융 상품</h2>
    {% if person.joined_products %}
      <p>{{ person.joined_products }}</p>
    {% else %}
      <p class="text-secondary mb-0">아직 가입한 상품이 없습니다.</p>
    {% endif %}
  </div>

  <!-- 내 게시글 -->
  <div class="section-card">
    <h2 class="h5">📌 {% if request.user != person %}{{ person.username }}님의 게시글{% else %}내 게시글{% endif %}</h2>
    {% if person.board_set.exists %}
      {% for board in person.board_set.all %}
        <div class="mb-3 p-3 bg-white rounded">
          <a href="{% url 'boards:detail' board.pk %}" class="h6 text-decoration-none text-dark">
            📝 {{ board.title }}
          </a>
          <div class="text-muted small">
            #{{ board.pk }} • {{ board.created_at|date:"Y.m.d H:i" }} • 댓글 {{ board.comments.count }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-secondary mb-0">작성한 게시글이 없습니다.</p>
    {% endif %}
  </div>

  <!-- 내 댓글 -->
  <div class="section-card">
    <h2 class="h5">💬 {% if request.user != person %}{{ person.username }}님의 댓글{% else %}내 댓글{% endif %}</h2>
    {% if person.comment_set.exists %}
      {% for comment in person.comment_set.all %}
        <div class="mb-3 p-3 bg-white rounded">
          <p class="mb-1">🗨️ “{{ comment.content }}”</p>
          <small class="text-muted">
            in <a href="{% url 'boards:detail' comment.board.pk %}">{{ comment.board.title }}</a>,
            {{ comment.created_at|date:"Y.m.d H:i" }}
          </small>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-secondary mb-0">작성한 댓글이 없습니다.</p>
    {% endif %}
  </div>

  <!-- 팔로워 목록 -->
  <div class="section-card">
    <h2 class="h5">👥 Follower</h2>
    {% if person.followers.exists %}
      {% for follower in person.followers.all %}
        <div class="mb-3 p-3 bg-white rounded">
          <a href="{% url 'accounts:profile' follower.pk %}" class="h6 text-decoration-none text-dark">
            👤 {{ follower.username }}
          </a>
          <div class="text-muted small">
            게시글 {{ follower.board_set.count }} • 팔로잉 {{ follower.followings.count }} • 팔로워 {{ follower.followers.count }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-secondary mb-0">Follower가 없습니다.</p>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // 아바타 클릭 → 파일 선택
  document.getElementById('avatar-click')
    .addEventListener('click', function() {
      document.getElementById('avatar-input').click();
    });
  // 파일 선택 후 자동 폼 제출
  document.getElementById('avatar-input')
    .addEventListener('change', function() {
      if (this.files.length) {
        document.getElementById('avatar-form').submit();
      }
    });
</script>
{% endblock %}
